<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Numpy: the Solution to Lists - Make Python Faster: a Practical Guide to Accelerating your Code</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> 📖 Introduction and ToC</a></li><li class="chapter-item "><a href="../when_to_optimise.html"><strong aria-hidden="true">2.</strong> ❓ When to Optimise</a></li><li class="chapter-item "><a href="../pythons_execution_model.html"><strong aria-hidden="true">3.</strong> 🐍 Python's Execution Model</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../the_global_interpreter_lock.html"><strong aria-hidden="true">3.1.</strong> 🔒 The Global Interpreter Lock</a></li></ol></li><li class="chapter-item "><a href="../alternative_python_interpreters.html"><strong aria-hidden="true">4.</strong> 🚀 Alternative Python Interpreters</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../alternative_python_interpreters/pypy.html"><strong aria-hidden="true">4.1.</strong> 🏎️ PyPy</a></li><li class="chapter-item "><a href="../alternative_python_interpreters/ironpython.html"><strong aria-hidden="true">4.2.</strong> 🔗 IronPython</a></li><li class="chapter-item "><a href="../alternative_python_interpreters/jython.html"><strong aria-hidden="true">4.3.</strong> ☕ Jython</a></li><li class="chapter-item "><a href="../alternative_python_interpreters/graalpython.html"><strong aria-hidden="true">4.4.</strong> 🌌 GraalPython</a></li><li class="chapter-item "><a href="../alternative_python_interpreters/cinder.html"><strong aria-hidden="true">4.5.</strong> 🔥 Cinder</a></li><li class="chapter-item "><a href="../alternative_python_interpreters/micropython.html"><strong aria-hidden="true">4.6.</strong> 🤖 MicroPython</a></li></ol></li><li class="chapter-item "><a href="../profiling_tools.html"><strong aria-hidden="true">5.</strong> 🔎 Profiling Tools</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../profiling_tools/time_time.html"><strong aria-hidden="true">5.1.</strong> 🕒 time.time()</a></li><li class="chapter-item "><a href="../profiling_tools/timeit.html"><strong aria-hidden="true">5.2.</strong> ⏱️ timeit</a></li><li class="chapter-item "><a href="../profiling_tools/unixs_time_command.html"><strong aria-hidden="true">5.3.</strong> ⏲️ Unix's time Command</a></li><li class="chapter-item "><a href="../profiling_tools/cprofile.html"><strong aria-hidden="true">5.4.</strong> 📊 cProfile</a></li><li class="chapter-item "><a href="../profiling_tools/snakeviz.html"><strong aria-hidden="true">5.5.</strong> 🐲 Snakeviz</a></li><li class="chapter-item "><a href="../profiling_tools/line_profiler.html"><strong aria-hidden="true">5.6.</strong> 📈 line_profiler</a></li><li class="chapter-item "><a href="../profiling_tools/memory_profiler.html"><strong aria-hidden="true">5.7.</strong> 🧠 memory_profiler</a></li><li class="chapter-item "><a href="../profiling_tools/py_spy.html"><strong aria-hidden="true">5.8.</strong> 🕵️‍♂️ Py-Spy</a></li></ol></li><li class="chapter-item "><a href="../built_in_data_structures.html"><strong aria-hidden="true">6.</strong> 🏗️ Built-in Data Structures</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../built_in_data_structures/lists.html"><strong aria-hidden="true">6.1.</strong> 📝 Lists</a></li><li class="chapter-item "><a href="../built_in_data_structures/tuples.html"><strong aria-hidden="true">6.2.</strong> 🎁 Tuples</a></li><li class="chapter-item "><a href="../built_in_data_structures/dictionaries.html"><strong aria-hidden="true">6.3.</strong> 🗝️ Dictionaries</a></li><li class="chapter-item "><a href="../built_in_data_structures/sets.html"><strong aria-hidden="true">6.4.</strong> 🎯 Sets</a></li><li class="chapter-item "><a href="../built_in_data_structures/general_tips.html"><strong aria-hidden="true">6.5.</strong> 💡 General Tips</a></li></ol></li><li class="chapter-item "><a href="../the_collections_module.html"><strong aria-hidden="true">7.</strong> The Collections Module</a></li><li class="chapter-item "><a href="../algorithm_complexity.html"><strong aria-hidden="true">8.</strong> Algorithm Complexity</a></li><li class="chapter-item "><a href="../optimising_common_algorithms.html"><strong aria-hidden="true">9.</strong> Optimising Common Algorithms</a></li><li class="chapter-item "><a href="../numpy_and_pandas.html"><strong aria-hidden="true">10.</strong> NumPy and Pandas</a></li><li class="chapter-item "><a href="../efficient_numerical_computations.html"><strong aria-hidden="true">11.</strong> Efficient Numerical Computations</a></li><li class="chapter-item "><a href="../optimising_data_manipulation.html"><strong aria-hidden="true">12.</strong> Optimising Data Manipulation</a></li><li class="chapter-item "><a href="../dask_and_polars.html"><strong aria-hidden="true">13.</strong> Dask and Polars</a></li><li class="chapter-item "><a href="../threading_and_multiprocessing.html"><strong aria-hidden="true">14.</strong> Threading and Multiprocessing</a></li><li class="chapter-item "><a href="../asynchronous_programming.html"><strong aria-hidden="true">15.</strong> Asynchronous Programming</a></li><li class="chapter-item "><a href="../concurrent_futures.html"><strong aria-hidden="true">16.</strong> concurrent.futures</a></li><li class="chapter-item "><a href="../c_extensions_for_python.html"><strong aria-hidden="true">17.</strong> C Extensions for Python</a></li><li class="chapter-item "><a href="../compiling_with_cython.html"><strong aria-hidden="true">18.</strong> Compiling with Cython</a></li><li class="chapter-item "><a href="../just_in_time_compilation.html"><strong aria-hidden="true">19.</strong> Just-in-Time Compilation</a></li><li class="chapter-item "><a href="../using_numba.html"><strong aria-hidden="true">20.</strong> Using Numba</a></li><li class="chapter-item "><a href="../memory_management.html"><strong aria-hidden="true">21.</strong> Memory Management</a></li><li class="chapter-item "><a href="../reducing_footprint_and_avoiding_leaks.html"><strong aria-hidden="true">22.</strong> Reducing Footprint and Avoiding Leaks</a></li><li class="chapter-item "><a href="../performant_web_applications.html"><strong aria-hidden="true">23.</strong> Performant Web Applications</a></li><li class="chapter-item "><a href="../caching_strategies.html"><strong aria-hidden="true">24.</strong> Caching Strategies</a></li><li class="chapter-item "><a href="../general_best_practices.html"><strong aria-hidden="true">25.</strong> General Best Practices</a></li><li class="chapter-item "><a href="../common_performance_anti_patterns.html"><strong aria-hidden="true">26.</strong> Common Performance Anti-Patterns</a></li><li class="chapter-item "><a href="../profiling.html"><strong aria-hidden="true">27.</strong> 🔎 Profiling</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../profiling/the_simplest_method.html"><strong aria-hidden="true">27.1.</strong> time.time() + print</a></li><li class="chapter-item "><a href="../profiling/unix_time_command.html"><strong aria-hidden="true">27.2.</strong> The Unix time Command</a></li><li class="chapter-item "><a href="../profiling/the_timeit_module.html"><strong aria-hidden="true">27.3.</strong> The timeit Module</a></li><li class="chapter-item "><a href="../profiling/function_calls_with_cprofile.html"><strong aria-hidden="true">27.4.</strong> Splitting Function Calls with cProfile</a></li><li class="chapter-item "><a href="../profiling/adding_decorator_function.html"><strong aria-hidden="true">27.5.</strong> Adding a Decorator Function</a></li><li class="chapter-item "><a href="../profiling/getting_granular_with_line_profiler.html"><strong aria-hidden="true">27.6.</strong> Getting Granular with line-profiler</a></li><li class="chapter-item "><a href="../profiling/profiling_memory_usage.html"><strong aria-hidden="true">27.7.</strong> Profiling Memory Usage</a></li><li class="chapter-item "><a href="../profiling/profiling_on_the_fly.html"><strong aria-hidden="true">27.8.</strong> Profiling on the Fly with Py-Spy</a></li></ol></li><li class="chapter-item expanded "><a href="../data_structures_and_algorithms.html"><strong aria-hidden="true">28.</strong> 🏛️ Data Structures and Algorithms</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../data_structures_and_algorithms/arrays_lists_vs_tuples.html"><strong aria-hidden="true">28.1.</strong> Arrays (Lists vs Tuples)</a></li><li class="chapter-item "><a href="../data_structures_and_algorithms/sets_and_dictionaries.html"><strong aria-hidden="true">28.2.</strong> Ready: Sets, Dictionaries</a></li><li class="chapter-item "><a href="../data_structures_and_algorithms/generator_comprehension_iteration_and_evaluation.html"><strong aria-hidden="true">28.3.</strong> Let's Get Generating</a></li><li class="chapter-item "><a href="../data_structures_and_algorithms/sensible_loop_design.html"><strong aria-hidden="true">28.4.</strong> Sensible Loop Design</a></li><li class="chapter-item expanded "><a href="../data_structures_and_algorithms/numpy_the_solution_to_lists.html" class="active"><strong aria-hidden="true">28.5.</strong> Numpy: the Solution to Lists</a></li><li class="chapter-item "><a href="../data_structures_and_algorithms/accelerating_pandas_with_cpus_and_gpus.html"><strong aria-hidden="true">28.6.</strong> Accelerating Pandas with CPUs and GPUs</a></li><li class="chapter-item "><a href="../data_structures_and_algorithms/dask_and_polars.html"><strong aria-hidden="true">28.7.</strong> Dask and Polars</a></li></ol></li><li class="chapter-item "><a href="../async_methods.html"><strong aria-hidden="true">29.</strong> ⏳ Async Methods</a></li><li class="chapter-item "><a href="../multiprocessing.html"><strong aria-hidden="true">30.</strong> 🏭 Multiprocessing</a></li><li class="chapter-item "><a href="../compiling_python.html"><strong aria-hidden="true">31.</strong> ⚙️ Compiling Python</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../compiling/cython_pure_c_based_compiling.html"><strong aria-hidden="true">31.1.</strong> Cython: Pure C-based Compiling</a></li><li class="chapter-item "><a href="../compiling/numba_llvm_based_compiling.html"><strong aria-hidden="true">31.2.</strong> Numba: LLVM-based Compiling</a></li><li class="chapter-item "><a href="../compiling/pypy_replacement_virtual_machine.html"><strong aria-hidden="true">31.3.</strong> PyPy: Replacement Virtual Machine</a></li><li class="chapter-item "><a href="../compiling/foreign_function_interfaces.html"><strong aria-hidden="true">31.4.</strong> Foreign Function Interfaces</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Make Python Faster: a Practical Guide to Accelerating your Code</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="numpy-the-solution-to-lists"><a class="header" href="#numpy-the-solution-to-lists">Numpy: the Solution to Lists</a></h1>
<p>Python's native list structure has a problem for vector operations and matrix manipulations. Lists don't actually hold the data - instead, they hold <strong>pointers</strong> to the data location. The advantage of this is that the contents of a list can be heterogenous. However, it introduces a fetch/look-up overhead, and if you are doing lots of operations, this fragmentation adds up.</p>
<p>What does this look like in hardware terms? Data needs to be moved from memory to the CPU. Modern computers can have tiered architectures, with DRAM, SRAM, external caches, and on-chip caches. CPUs can also do things like branch prediction, speculation, overlapped instruction fetching, pipelining, and superscalar execution. If you want to get into the weeds, you can use the Linux <code>perf</code> tool to do some profiling, looking for <code>cache-misses</code> (memory bound) and <code>page-faults</code> (disk/network bound). But we might as well be sensible with how we do things.</p>
<h3 id="the-array-module"><a class="header" href="#the-array-module">The Array Module?</a></h3>
<p>Python offers an <code>array</code> module, that overcomes the memory fragementation issue by storing items sequentially. Iterating through an array therefore doesn't require multiple look-ups, as data can be cached (i.e. closer in terms of spatial and temporal locality to the CPU). But then we run into a different issue: Python, as a high-level interpreted language, isn't optimised for vector operations, and isn't good at dealing with the low-level implementation of <code>array</code>.</p>
<h2 id="enter-numpy"><a class="header" href="#enter-numpy">Enter NumPy</a></h2>
<p>NumPy stores items sequentially in memory AND offers optimised vector operations. It requires orders of magnitude less instructions, and gets more data onto the cache, closer to the CPU. It also has a relatively concise syntax, which can make code cleaner too.</p>
<p>Let's compare generating two million-item lists and doing multitiplication. First, in native Python:</p>
<pre><code class="language-python">import random
# Generating two vectors of a million items each
vector_a = [random.random() for _ in range(1_000_000)]
vector_b = [random.random() for _ in range(1_000_000)]

# Calculate dot product using a loop
result = 0
for i in range(len(vector_a)):
    result += vector_a[i] * vector_b[i]
</code></pre>
<p>Here's the equivalent in <code>NumPy</code>:</p>
<pre><code class="language-python">import numpy as np

# Generating two vectors of a million items each
vector_a = np.random.rand(1_000_000)
vector_b = np.random.rand(1_000_000)

# Perform dot product
result = np.dot(vector_a, vector_b)
</code></pre>
<p>On my local machine, the second block of code took 0.025 seconds, versus 0.443 for the native Python. That's almost a 17x speed-up! And the NumPy syntax is much cleaner than a foreloop with array indexing.</p>
<h2 id="using-numexpr"><a class="header" href="#using-numexpr">Using <code>numexpr</code></a></h2>
<p>An issue you might face with <code>NumPy</code> is that it processes operations one by one, and stores intermediate results in temporary arrays. <code>numexpr</code> lets you compile a multi-step vector expression into something more efficient. It even supports parallelism.</p>
<p>Let's imagine we want to calculate the following: <code>(a * b) + sqrt(a + b)</code>. Here's how we'd do it in NumPy:</p>
<pre><code class="language-python">import numpy as np
import time

vector_a = np.random.rand(1_000_000)
vector_b = np.random.rand(1_000_000)

result_np = (vector_a * vector_b) + np.sqrt(vector_a + vector_b)
</code></pre>
<p>This took a little longer on my machine: 0.028 seconds. To use <code>numexpr</code>, we have to enter the calculation as a string:</p>
<pre><code class="language-python">import numpy as np
import numexpr as ne

# Generating two vectors of a million items each
vector_a = np.random.rand(1_000_000)
vector_b = np.random.rand(1_000_000)

result_ne = ne.evaluate("(vector_a * vector_b) + sqrt(vector_a + vector_b)")
</code></pre>
<p>This was a blazing fast 0.006 seconds, a further 4.7x speedup...</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../data_structures_and_algorithms/sensible_loop_design.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../data_structures_and_algorithms/accelerating_pandas_with_cpus_and_gpus.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../data_structures_and_algorithms/sensible_loop_design.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../data_structures_and_algorithms/accelerating_pandas_with_cpus_and_gpus.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
